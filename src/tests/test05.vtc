varnishtest "test regex match on req body"

server s1 {
        rxreq
        txresp
} -start

varnish v1 -vcl+backend {
	import bodyaccess from "${vmod_topbuild}/src/.libs/libvmod_bodyaccess.so";
	import std;
	
	sub vcl_recv {
                if (req.url ~ "/2") {
		        std.cache_req_body(100B);
		        set req.http.req_body = bodyaccess.req_body();
		        set req.http.foobar = regsub(req.http.req_body, "NE", "NAS");
                        unset req.http.req_body;
                        return (synth(201, req.http.foobar));
                }
	}
} -start

client c1 {
	txreq -url "/1"
	rxresp
        expect resp.status == 200

	txreq -url "/2" -req "POST" -body {BANANE}
	rxresp
        expect resp.status == 201
} -run
